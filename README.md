# DevContainers — управляемые dev-контейнеры для Fedora Atomic

## Что это?

Набор скриптов и структуры каталогов для управления **локальными контейнерами разработки** на базе:

* Fedora Atomic (Kinoite / Silverblue / CoreOS-подход)
* Podman (rootless)
* Distrobox
* Toolbox

Проект реализует подход:

> Хост — максимально чистый.
> Всё окружение разработки — в контейнерах.
> Контейнеры воспроизводимы и пересобираемы.

* декларативная база (`Containerfile`)
* автоматическая пересборка
* контролируемое пересоздание контейнеров
* разделение base и конкретных окружений

---

# Архитектура

```
~/containers/
│
├── aliases.sh          # команды управления
├── build.sh            # сборка образов + пересоздание контейнеров
│
└── base/
    ├── Containerfile
    ├── install.sh
    ├── postinstall.sh
    └── home/
        └── .bashrc
```

---

# Основная идея

## 1. Базовый образ (`base`)

`base/Containerfile` — фундамент всей системы.

Сейчас:

* Fedora 43
* dnf update
* vim
* mc
* nvm + Node 24 (через postinstall)
* базовый `.bashrc`

Сборка:

```bash
./build.sh base
```

Создаёт:

```
localhost/base:latest
```

---

## 2. Managed-контейнеры

Контейнер считается "управляемым", если:

* он создан из `localhost/<name>:latest`
* и существует `~/containers/<name>/Containerfile`

Такие контейнеры:

* автоматически пересоздаются при rebuild образа
* не затрагивают сторонние контейнеры

---

# Принцип работы

## Пересборка base

```bash
./build.sh
```

Поведение:

* Пересобирается `localhost/base:latest`
* Пересоздаются ВСЕ managed-контейнеры
* Сторонние контейнеры (например из registry) игнорируются

---

## Пересборка конкретного контейнера

```bash
./build.sh test
```

Поведение:

* Пересобирается `localhost/test:latest`
* Пересоздаются только контейнеры, реально использующие этот образ

---

# Distrobox vs Toolbox

## Distrobox (`dc`)

Используется как dev-shell контейнер.

Особенности:

* `--network host`
* отдельный `$HOME/env/<name>`
* overlay home:

  * сначала `base/home`
  * затем `containers/<name>/home`
* `.ssh` всегда ссылка на хост
* optional postinstall

Создание:

```bash
dc test
```

Удаление:

```bash
dr test
```

---

## Toolbox (`tc`)

Используется как "плотно интегрированный" контейнер.

Создание:

```bash
tc atomcore
```

Если существует образ:

```
localhost/<name>:latest
```

— используется он.
Иначе fallback на:

```
localhost/base:latest
```

---

# Dev-философия

## Immutable-эмуляция

Контейнеры:

* всегда пересоздаются
* не редактируются вручную
* воспроизводимы

Любое изменение — через:

```
Containerfile
install.sh
postinstall.sh
home/
```

---

# Как добавить новый контейнер

## 1. Создать структуру

```
containers/
└── myapp/
    ├── Containerfile
    ├── home/
    └── postinstall.sh
```

## 2. Собрать

```bash
./build.sh myapp
```

## 3. Создать контейнер

```bash
dc myapp
```

---

# Home overlay

При создании distrobox контейнера:

1. Копируется `base/home`
2. Поверх накладывается `containers/<name>/home`
3. `.ssh` — ссылка на хост
4. Запускаются postinstall скрипты

Это позволяет:

* держать общий baseline
* переопределять конфиг локально
* сохранять SSH доступ

---

# Node.js

Устанавливается через `nvm`:

* каталог: `$HOME/.config/nvm`
* версия: 24 (LTS)
* `corepack enable`

В `.bashrc` автоматически подключается nvm.

---

# Что проект НЕ делает

* Не управляет pods
* Не заменяет docker-compose
* Не является оркестратором
* Не трогает сторонние контейнеры
* Не управляет registry

Это **инструмент разработки**, а не прод-оркестрация.

---

# Требования

* Fedora Atomic (Kinoite / Silverblue)
* podman
* distrobox
* toolbox

---

# Команды

| Команда             | Назначение                     |
| ------------------- | ------------------------------ |
| `dc <name>`         | создать distrobox контейнер    |
| `dr <name>`         | удалить distrobox контейнер    |
| `tc <name>`         | создать toolbox контейнер      |
| `tr <name>`         | удалить toolbox контейнер      |
| `./build.sh base`   | пересобрать base и все managed |
| `./build.sh <name>` | пересобрать конкретный образ   |

---

# Результат

* Хост остаётся чистым
* rpm-ostree не засоряется
* dev-окружение полностью контролируемо
* контейнеры пересобираются одной командой
* минимум магии

---

# Кому это нужно?

* Разработчику на Fedora Atomic
* Тем, кто не хочет засорять хост
* Тем, кто хочет reproducible окружение, но не хочет NixOS

---

Если кратко:

> Это управляемая система dev-контейнеров с декларативной базой и автоматическим пересозданием.
> Минимум магии. Максимум контроля.
